//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/Color dojo/DeferredList dojo/dom-class dojo/dom-construct dojo/dom-style dojo/on esri/geometry/geometryEngine esri/graphic esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/Font esri/symbols/TextSymbol esri/tasks/query ./Util".split(" "),function(z,q,v,A,d,h,B,s,C,w,x,y,D,E,F,G){return z("ProximityInfo",null,{constructor:function(b,c,a){this.tab=b;this.container=c;this.parent=a;this.graphicsLayer=this.incident=null},updateForIncident:function(b,
c,a){this.container.innerHTML="Loading...";var m=[];this.incident=b;this.graphicsLayer=a;var g=this.tab.tabLayers;a=[];for(var e=0;e<g.length;e++){var f=g[e],d=new F;d.returnGeometry=!0;d.geometry=c.geometry;a.push(f.queryFeatures(d))}(new A(a)).then(q.hitch(this,function(a){for(var c=0;c<a.length;c++)for(var e=a[c][1],f=this._getFields(g[c]),e=e.features,d=0;d<e.length;d++){var h=e[d],p=h.geometry;"point"!==p.type&&p.getExtent().getCenter();for(var p={DISTANCE:this._getDistance(b.geometry,p)},l=
0;l<f.length;l++)p[f[l]]=h.attributes[f[l]];h.attributes=p;m.push(h)}this._processResults(m)}))},_processResults:function(b){this.container.innerHTML="";this.graphicsLayer.clear();if(0===b.length)this.container.innerHTML=this.parent.nls.noFeaturesFound;else{b.sort(this._compareDistance);var c=h.create("div",{id:"tpc",style:"width:"+220*(b.length+1)+"px;"},this.container);d.add(c,"IMT_tabPanelContent");var a=h.create("div",{},c);d.add(a,"IMTcol");a=h.create("div",{innerHTML:this.parent.nls.downloadCSV},
a);d.add(a,"btnExport");s(a,"click",q.hitch(this,this._exportToCSV,b));for(var a=this.parent.nls[this.parent.config.distanceUnits],m=0;m<b.length;m++){var g=m+1,e=b[m],f=e.geometry,l=f;"point"!==f.type&&(l=f.getExtent().getCenter());var e=e.attributes,n=a+": "+Math.round(100*e.DISTANCE)/100,f="",k=0,t;for(t in e)"DISTANCE"!==t&&3>k&&(f+=e[t]+"\x3cbr/\x3e",k+=1);k=h.create("div",{id:"Feature_"+g},c);d.add(k,"IMTcolRec");var r=h.create("div",{},k);d.add(r,"IMTcolRecBar");var u=h.create("div",{innerHTML:g},
r);d.add(u,"IMTcolRecNum");B.set(u,"backgroundColor",this.parent.config.color);s(u,"click",q.hitch(this,this._zoomToLocation,l));n=h.create("div",{innerHTML:n},r);d.add(n,"IMTcolDistance");this.parent.config.enableRouting&&(n=h.create("div",{},r),d.add(n,"IMTcolDir"),s(n,"click",q.hitch(this,this._routeToIncident,l)));f=h.create("div",{innerHTML:f},k);d.add(f,"IMTcolInfo");f=new y(y.STYLE_SOLID,new v.fromString(this.parent.config.color),1);f=new x(x.STYLE_CIRCLE,24,f,new v.fromString(this.parent.config.color));
k=new D;k.family="Arial";k.size="12px";g=new E(g,k,"#ffffff");g.setOffset(0,-4);this.graphicsLayer.add(new w(l,f,e));this.graphicsLayer.add(new w(l,g,e))}}},_exportToCSV:function(b){console.log("csv");if(0===b.length)return!1;var c="",a,d;a=b[0].attributes;for(d in a)c+=(0===c.length?"":",")+'"'+d+'"';for(var c=c+"\r\n",g="",e=0;e<b.length;e++){g="";a=b[e].attributes;for(d in a)g+=(0===g.length?"":",")+'"'+a[d]+'"';c+=g+"\r\n"}G.download(this.container,this.tab.tabLayers[0].id+".csv",c)},_getFields:function(b){var c=
[];b=b.infoTemplate.info.fieldInfos;for(var a=0;a<b.length;a++){var d=b[a];d.visible&&c.push(d.fieldName)}return c},_getDistance:function(b,c){var a=0,d=this.parent.config.distanceUnits,a=C.distance(b,c,9001);switch(d){case "miles":a*=6.21371E-4;break;case "kilometers":a*=0.0010;break;case "feet":a*=3.28084;break;case "yards":a*=1.09361;break;case "nauticalMiles":a*=5.39957E-4}return a},_compareDistance:function(b,c){return b.attributes.DISTANCE<c.attributes.DISTANCE?-1:b.attributes.DISTANCE>c.attributes.DISTANCE?
1:0},_zoomToLocation:function(b){this.parent.zoomToLocation(b)},_routeToIncident:function(b){this.parent.routeToIncident(b)}})});